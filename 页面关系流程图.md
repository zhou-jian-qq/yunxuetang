# 云学堂自动学习脚本 - 页面关系流程图 (Mermaid版)

## 主学习流程

```mermaid
flowchart TD
    Start([开始]) --> TaskCenter[任务中心页<br/>/plan/*.html<br/>学习任务列表]
    
    TaskCenter --> CheckTask{检查任务进度}
    CheckTask -->|全部100%| End([结束])
    CheckTask -->|有待完成任务| TaskList[任务列表页<br/>/plan/*.html<br/>学习计划明细]
    
    TaskList --> PackageList[课程包列表页<br/>/knowledgecatalogsearch<br/>课程列表]
    
    PackageList --> CheckRefresh{是否需要刷新?}
    CheckRefresh -->|是| Reload[刷新页面清除标记]
    Reload --> PackageList
    
    CheckRefresh -->|否| CheckCourse{检查课程进度}
    CheckCourse -->|本页全部100%| NextPage[下一页]
    NextPage --> PackageList
    CheckCourse -->|有未学习课程| CourseDetail[课程包明细页<br/>/plan/package/*<br/>课程详情]
    
    CourseDetail --> CheckProgress{检查课程包进度}
    CheckProgress -->|100%| PackageList
    CheckProgress -->|未完成| StartStudy[点击开始学习按钮]
    
    StartStudy --> MediaType{学习内容类型?}
    
    MediaType -->|视频| VideoPage[视频播放页<br/>/video/*<br/>视频学习]
    MediaType -->|文档| DocPage[文档播放页<br/>/document/*<br/>文档浏览]
    
    VideoPage --> Monitor1[每15秒检测循环]
    DocPage --> Monitor2[每15秒检测循环]
    
    Monitor1 --> CheckOnline1[在线检测]
    Monitor1 --> CheckCheat1[防作弊弹窗]
    Monitor1 --> CheckPlay{播放状态检测}
    Monitor1 --> CheckComplete1[完成度检测]
    
    Monitor2 --> CheckOnline2[在线检测]
    Monitor2 --> CheckCheat2[防作弊弹窗]
    Monitor2 --> CheckComplete2[完成度检测]
    
    CheckPlay -->|播放中| SetSpeed[设置2倍速<br/>重置暂停次数]
    CheckPlay -->|缓冲中| ReloadPage[延迟1秒刷新页面]
    CheckPlay -->|已暂停| AutoPlay[自动播放<br/>记录暂停次数]
    CheckPlay -->|暂停超过5次| ReloadPage
    CheckPlay -->|播放完成| GoBackLevel
    
    CheckComplete1 --> CompleteStatus{进度100%?}
    CheckComplete2 --> CompleteStatus
    
    CompleteStatus -->|是| SetRefresh[设置刷新标记]
    SetRefresh --> GoBackLevel[返回上一级]
    
    CompleteStatus -->|否| VideoPage
    GoBackLevel --> CourseDetail
    
    style TaskCenter fill:#e1f5fe
    style TaskList fill:#e1f5fe
    style PackageList fill:#e1f5fe
    style CourseDetail fill:#e1f5fe
    style VideoPage fill:#fff3e0
    style DocPage fill:#fff3e0
    style Start fill:#c8e6c9
    style End fill:#ffcdd2
```

## 考试流程

```mermaid
flowchart TD
    Start([开始考试流程])
    
    Start --> ExamPreview[考试预览页<br/>/exampreview.htm<br/>开始考试前]
    
    ExamPreview --> AddToggle[添加自动提交开关]
    
    AddToggle --> CheckAuto{自动提交开启?}
    
    CheckAuto -->|否| ManualExam[手动考试]
    ManualExam --> ExamResult
    
    CheckAuto -->|是| AutoExam[5秒后自动进入考试]
    
    AutoExam --> ExamPage[考试页面<br/>/userexam.htm<br/>答题页面]
    
    ExamPage --> AutoSubmit[3秒后自动提交]
    AutoSubmit --> ConfirmModal[6秒后点击确认弹窗]
    
    ConfirmModal --> ExamResult[考试结果页<br/>/viewexamresult.htm<br/>显示成绩]
    
    ExamResult --> CheckNewTab{是否新开标签?}
    
    CheckNewTab -->|是| CloseWindow[关闭当前窗口]
    CheckNewTab -->|否| ReturnPage[3秒后返回课程包详情]
    
    CloseWindow --> End([结束])
    ReturnPage --> End
    
    style ExamPreview fill:#e3f2fd
    style ExamPage fill:#fff3e0
    style ExamResult fill:#e8f5e9
    style Start fill:#c8e6c9
    style End fill:#ffcdd2
```

## 视频播放状态检测详细流程

```mermaid
stateDiagram-v2
    [*] --> Playing: 播放中
    
    Playing --> SetSpeed: 设置2倍速<br/>重置暂停计数
    
    Playing --> Buffering: 进入缓冲状态
    Buffering --> Reload: 延迟1秒刷新页面
    
    Playing --> Paused: 用户暂停
    Paused --> AutoPlay: 自动播放
    
    AutoPlay --> Counter: 暂停次数+1
    Counter --> CheckCount: 检查暂停次数
    
    CheckCount --> AutoPlay: 次数 ≤ 5
    CheckCount --> Reload: 次数 > 5
    
    Playing --> Complete: 播放完成
    Complete --> GoBack: 返回上一级
    
    Reload --> [*]
    GoBack --> [*]
    
    note right of Paused
        自动播放
        记录暂停次数
    end note
    
    note right of Counter
        超过5次暂停
        刷新页面
    end note
```

## 页面跳转关系图

```mermaid
graph LR
    subgraph "任务中心"
        A1[任务中心页<br/>选择任务]
    end
    
    subgraph "任务列表"
        B1[任务列表页<br/>查看明细]
    end
    
    subgraph "课程包"
        C1[课程包列表页]
        C2[课程包明细页]
    end
    
    subgraph "学习内容"
        D1[视频播放页]
        D2[文档播放页]
    end
    
    subgraph "考试系统"
        E1[考试预览页]
        E2[考试页面]
        E3[考试结果页]
    end
    
    A1 -->|点击未完成任务| B1
    B1 -->|选择课程| C1
    C1 -->|点击未学习课程| C2
    C2 -->|开始学习| D1
    C2 -->|开始学习| D2
    D1 -.->|完成后返回| C2
    D2 -.->|完成后返回| C2
    C2 -.->|完成后返回| C1
    C1 -->|下一个| C1
    C2 -->|可能触发| E1
    E1 -->|进入考试| E2
    E2 -->|提交| E3
    E3 -->|返回| C2
    
    style A1 fill:#e1f5fe
    style B1 fill:#e1f5fe
    style C1 fill:#e1f5fe
    style C2 fill:#e1f5fe
    style D1 fill:#fff3e0
    style D2 fill:#fff3e0
    style E1 fill:#f3e5f5
    style E2 fill:#f3e5f5
    style E3 fill:#f3e5f5
```

## 关键检测循环机制

```mermaid
graph TB
    subgraph "每15秒检测循环"
        A[检测开始]
        
        A --> B1[在线检测<br/>detectionOnline]
        B1 --> Check1{弹窗检测}
        Check1 -->|检测到弹窗| Click1[点击确认按钮]
        Check1 -->|无弹窗| B2
        
        Click1 --> B2
        
        A --> B2[防作弊检测<br/>checkMoreOpen]
        B2 --> Check2{多开弹窗?}
        Check2 -->|有| Close1[关闭弹窗]
        Check2 -->|无| B3
        
        Close1 --> B3
        
        A --> B3[完成度检测<br/>detectionComplete]
        B3 --> Check3{进度100%?}
        Check3 -->|是| SetRefresh[设置刷新标记<br/>返回上一级]
        Check3 -->|否| B4
        
        SetRefresh --> End1[循环结束]
        B4 --> End1
        
        A --> B4[仅视频页<br/>播放状态检测<br/>detectPlaybackStatus]
        B4 --> Check4{播放状态?}
        Check4 -->|播放中| SetSpeed[设置2倍速]
        Check4 -->|缓冲中| Reload[刷新页面]
        Check4 -->|已暂停| AutoPlay[自动播放]
        Check4 -->|已完成| GoBack[返回上一级]
        
        SetSpeed --> End1
        Reload --> End1
        AutoPlay --> End1
        GoBack --> End1
        
        End1 --> Wait[等待15秒]
        Wait --> A
    end
    
    style A fill:#c8e6c9
    style End1 fill:#ffcdd2
    style Check1 fill:#fff9c4
    style Check2 fill:#fff9c4
    style Check3 fill:#fff9c4
    style Check4 fill:#fff9c4
```

## URL匹配规则

| 页面类型 | 匹配模式 | 代码行数 | 说明 |
|---------|---------|---------|------|
| 任务列表页 | `^\/plan.*` | 54-69 | 选择未完成任务 |
| 文档播放页 | `^\/kng\/.*\/document.*` | 71-82 | 文档学习页面 |
| 视频播放页 | `^\/kng\/.*\/video.*` | 84-99 | 视频学习页面 |
| 课程包明细页 | `^\/kng\/\w*\/package.*` | 100-115 | 课程包详情 |
| 课程包列表页 | `^\/kng\/knowledgecatalogsearch.*` | 116-152 | 课程包列表 |
| 签到页 | `^\/sty.*` | 153-157 | 自动签到 |
| 考试预览页 | `^\/exam\/exampreview.*` | 158-265 | 开始考试 |
| 考试页面 | `^\/exam\/test\/userexam.*` | 269-286 | 答题页面 |
| 考试结果页 | `^\/exam\/viewexamresult.*` | 289-304 | 考试结果 |

## 核心存储键值

| 键名 | 说明 | 用途 |
|-----|------|------|
| `auto_submit` | 自动提交考试 | 控制是否自动提交考试 |
| `kng_href_key` | 课程包URL | 保存当前课程包地址用于返回 |
| `course_package_refresh_key` | 刷新标记 | 标记是否需要在列表页刷新 |
| `exam_open_page_key` | 新开标签标记 | 判断考试是否在新标签打开 |
| `numberOfVideoPlaybackPauses` | 暂停次数 | 记录视频暂停次数，超过5次刷新 |
