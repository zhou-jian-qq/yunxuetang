# 云学堂自动学习脚本 - 页面关系流程图

## 整体流程概览

```
┌─────────────────┐
│   任务中心页    │  (学习任务列表)
│  /plan/*.html   │
└────────┬────────┘
         │ 点击未完成的任务(进度 < 100%)
         ↓
┌─────────────────┐
│   任务列表页    │  (用户学习计划明细)
│  /plan/*.html   │
└────────┬────────┘
         │ 选择未学习内容
         ↓
┌─────────────────┐
│   课程包列表页  │  (找知识查看子目录)
│/knowledgecata...│
└────────┬────────┘
         │ 点击未学习课程
         ↓
┌─────────────────┐
│   课程包明细页  │  (课程包详情)
│ /plan/package/* │
└────────┬────────┘
         │
         ├──→ 进度 = 100%? → 返回列表页
         │
         └──→ 点击"开始学习"按钮
              ↓
         ┌──────────────────┐
         │  视频/文档播放页  │
         │ /video/* 或      │
         │ /document/*      │
         └────────┬─────────┘
                  │
                  ├─────────────────────────┐
                  │                         │
                  ↓                         ↓
          ┌──────────────┐        ┌─────────────────┐
          │  视频播放页  │        │   文档播放页     │
          │ /video/*    │        │ /document/*     │
          └──────┬───────┘        └────────┬─────────┘
                 │                         │
                 │ 每15秒检测:             │ 每15秒检测:
                 │ - 在线检测              │ - 在线检测
                 │ - 防作弊弹窗            │ - 防作弊弹窗
                 │ - 播放状态              │ - 完成度检测
                 │ - 完成度检测            │
                 │                         │
                 ↓                         ↓
          ┌──────────────────────────────┐
          │     完成检测 (100%)?          │
          └─────────────┬────────────────┘
                        │
                        ├──→ 未完成 → 继续学习
                        │
                        └──→ 已完成 → 设置刷新标记 → 返回上一级
```

## 详细页面说明

### 1. 任务中心页 `/plan/*.html` (第54-69行)

**功能**: 学习任务列表页，展示所有学习任务

- **匹配**: `path.match(/^\/plan.*/g)`
- **行为**:
  - 遍历所有任务，查找进度 < 100% 的任务
  - 延迟10秒后自动点击未完成的任务
  - 跳转到任务列表页

### 2. 任务列表页 `/plan/*.html`

**功能**: 用户学习计划明细

- 显示具体的学习任务列表
- 用户选择要学习的课程

### 3. 课程包列表页 `/kng/knowledgecatalogsearch.*` (第116-152行)

**功能**: 课程包列表，显示所有可学习课程

- **匹配**: `path.match(/^\/kng\/knowledgecatalogsearch.*/g)`
- **行为**:
  - 检查是否需要刷新 (从localStorage获取 `course_package_refresh_key`)
  - 如果标记为刷新，则重新加载页面并清除标记
  - 否则遍历课程列表，查找未完成课程 (text == '')
  - 延迟10秒后点击第一个未学习的课程
  - 如果本页所有课程都已完成，点击"下一页"

### 4. 课程包明细页 `/kng/plan/package/*` (第100-115行)

**功能**: 课程包详情页，显示课程包信息和开始学习按钮

- **匹配**: `path.match(/^\/kng\/\w*\/package.*/g)`
- **行为**:
  - 检查进度是否为100%
  - 如果已完成，3秒后返回课程包列表页
  - 否则3秒后点击"开始学习"按钮 (`#btnStartStudy`)

### 5. 视频播放页 `/kng/*/video/*` (第84-99行)

**功能**: 视频学习页面

- **匹配**: `path.match(/^\/kng\/.*\/video.*/g)` 或 `/kng/course/package/video.*`
- **每15秒检测**:
  - **在线检测** (`detectionOnline`): 检测"请不要走开喔"弹窗并自动点击
  - **防作弊弹窗** (`checkMoreOpen`): 检测并关闭防作弊弹窗
  - **播放状态检测** (`detectPlaybackStatus`):
    - 如果播放中，设置2倍速
    - 如果缓冲中，刷新页面
    - 如果暂停了，自动播放；如果暂停次数超过5次，刷新页面
    - 如果播放完成，返回上一级
  - **完成度检测** (`detectionComplete`): 检查进度是否为100%，完成后返回上一级

### 6. 文档播放页 `/kng/*/document/*` (第71-82行)

**功能**: 文档学习页面

- **匹配**: `path.match(/^\/kng\/.*\/document.*/g)` 或 `/kng/course/package/document.*`
- **每15秒检测**:
  - **在线检测** (`detectionOnline`): 同视频页
  - **防作弊弹窗** (`checkMoreOpen`): 同视频页
  - **完成度检测** (`detectionComplete`): 同视频页

### 7. 考试相关页面

#### 7.1 考试预览页 `/exam/exampreview.*` (第158-265行)

- **功能**: 开始考试前的预览页
- **行为**:
  - 添加"自动提交"开关按钮
  - 如果开启自动提交，5秒后进入考试
  - 检测是否在新标签页打开

#### 7.2 考试页面 `/exam/test/userexam.*` (第269-286行)

- **功能**: 考试答题页面
- **行为**:
  - 如果开启自动提交，3秒后自动点击提交按钮
  - 6秒后点击确认提交弹窗

#### 7.3 考试结果页 `/exam/viewexamresult.*` (第289-304行)

- **功能**: 显示考试结果
- **行为**:
  - 3秒后返回课程包列表
  - 如果在新标签页，则关闭当前页；否则在当前页跳转

### 8. 签到页面 `/sty.*` (第153-157行)

- **功能**: 学习任务签到
- **行为**: 3秒后自动签到

## 核心辅助函数

### LocalStorage 键值管理

```javascript
AUTO_SUBMIT_KEY = "auto_submit"  // 是否自动提交考试
COURSE_PACKAGE_URL_ADDRESS_KEY = "kng_href_key"  // 课程包URL地址
COURSE_PACKAGE_REFRESH_KEY = "course_package_refresh_key"  // 课程包列表刷新标记
EXAM_OPEN_PAGE_KEY = "exam_open_page_key"  // 是否新打开页面
NUMBER_OF_VIDEO_PLAYBACK_PAUSES = 'numberOfVideoPlaybackPauses'  // 视频暂停次数
```

### 关键函数

1. **`detectionOnline()`** (第369-387行)
   - 检测"请不要走开喔"弹窗，自动点击确认

2. **`checkMoreOpen()`** (第339-367行)
   - 检测并关闭防作弊弹窗
   - 处理学习顺序控制弹窗
   - 处理文档学习弹窗

3. **`detectPlaybackStatus()`** (第413-447行)
   - 检测视频播放状态
   - 自动播放、设置倍速、刷新页面

4. **`detectionComplete()`** (第403-410行)
   - 检测学习进度是否100%
   - 完成后设置刷新标记并返回

5. **`returnToThePreviousLevel()`** (第389-400行)
   - 返回上一级页面，使用浏览器历史或GoBack()

6. **`getKngUrl()` / `updateKngUrl()`** (第308-316行)
   - 保存和获取课程包URL地址

## 学习流程示例

```
1. 进入任务中心 → 选择未完成任务
2. 查看任务列表 → 选择课程
3. 进入课程包列表 → 找到未学习课程
4. 进入课程包详情 → 点击"开始学习"
5. 播放视频/文档
   ├─ 每15秒检测在线状态
   ├─ 每15秒检测防作弊弹窗
   ├─ (视频)每15秒检测播放状态，自动播放和设置倍速
   └─ 每15秒检测完成度
6. 进度100%后返回课程包详情
7. 继续下一个课程，重复步骤4-6
8. 课程包完成后返回课程包列表
9. 继续下一个课程包，重复步骤3-8
10. 所有任务完成后结束
```

## 考试流程（开启自动提交）

```
1. 进入考试预览页 → 点击"开始考试"
2. 3秒后自动提交答案
3. 显示考试结果
4. 3秒后返回课程包详情或关闭窗口
```
